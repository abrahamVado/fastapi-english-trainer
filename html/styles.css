
  :root{
    --bg1:#111827; --bg2:#1f2937;
    --surface: rgba(255,255,255,.08);
    --ring: rgba(236,72,153,.45);
    --accent:#ec4899; --accent-2:#f472b6;
    --ink:#f3f4f6; --ink-muted:#9ca3af;
    --bot:#1f2937; --user:#374151;
    --ok:#22c55e; --warn:#eab308; --err:#ef4444;
    --radius: 18px;
    --shadow-lg: 0 20px 40px rgba(0,0,0,.4), 0 4px 12px rgba(0,0,0,.3);
    --shadow-md: 0 10px 20px rgba(0,0,0,.3), 0 2px 8px rgba(0,0,0,.2);
    --chip-bg: rgba(255,255,255,.12);
    --avatar: 40px; --avatar-sm: 36px;
    --sidebar-w: 220px;
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    background:
      radial-gradient(1200px 900px at 15% -15%, #1e40af22 0%, transparent 70%),
      radial-gradient(1000px 800px at 115% 15%, #ec489922 0%, transparent 60%),
      linear-gradient(135deg,var(--bg1),var(--bg2));
    background-attachment: fixed;
    display:flex; flex-direction:column;
  }

  /* App fills viewport height (minus the 24px top/bottom margin) */
  .app {
    display: grid;
    grid-template-rows: auto minmax(0,1fr); /* header + body */
    height: calc(100vh - 48px);
    max-width: 1320px; width: 100%;
    margin: 24px auto;
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    background: var(--surface);
    border:1px solid rgba(255,255,255,.1);
    min-height: 0; /* allow inner grids to shrink */
  }

  .app-header {
    display:flex; align-items:center; gap:14px;
    padding:12px 16px; border-bottom:1px solid rgba(255,255,255,.1);
  }
  .logo{ width:36px;height:36px;border-radius:12px;
    background: conic-gradient(from 0deg,var(--accent-2),var(--accent),#db2777,var(--accent-2));
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.25), var(--shadow-md);
  }
  .title{ font-weight:600; letter-spacing:.3px; font-size:1.05rem }
  .status-chip{
    margin-left:auto; font-size:.9rem; background:var(--surface);
    border:1px solid rgba(255,255,255,.1); padding:8px 12px; border-radius:999px;
    display:flex; align-items:center; gap:8px; box-shadow:var(--shadow-md);
  }
  .dot{ width:9px;height:9px;border-radius:50%; background:var(--ok); box-shadow:0 0 4px var(--ok) }
  .dot.warn{ background:var(--warn); box-shadow:0 0 4px var(--warn) }
  .dot.err{ background:var(--err); box-shadow:0 0 4px var(--err) }

  /* ==== Body: sticky sidebar + stretch main panel ==== */
  .app-body {
    display:grid;
    grid-template-columns: var(--sidebar-w) 1fr;
    gap: 16px;
    padding: 16px;
    min-height: 0; /* critical for inner overflow to work */
  }
  @media (max-width: 900px){
    .app-body { grid-template-columns: 1fr; }
    .agent-sidebar { order:2; flex-direction:row; gap:8px; position:static; } /* no sticky on narrow screens */
    .agent-sidebar .stack { flex-direction:row; width:100%; }
    .agent-sidebar .toolbtn { flex:1 }
  }

  /* Sidebar stays visible while main scrolls */
  .agent-sidebar{
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.1);
    border-radius:12px;
    box-shadow: var(--shadow-md);
    padding:12px;
    display:flex; flex-direction:column; gap:12px;
    min-height: 120px;
    position: sticky; top: 16px; align-self: start;
    height: fit-content;
  }
  .side-title{ font-weight:700; letter-spacing:.3px; opacity:.9 }
  .stack{ display:flex; flex-direction:column; gap:8px }
  .toolbtn{
    appearance:none; border:1px solid rgba(255,255,255,.14);
    background:var(--chip-bg); color:var(--ink);
    padding:10px 12px; border-radius:12px; cursor:pointer;
    font-weight:700; font-size:.95rem; text-align:left;
  }
  .toolbtn:hover{ filter: brightness(1.08) }
  .toolbtn.active{
    background: linear-gradient(180deg, var(--accent-2), var(--accent));
    border-color: transparent; color:#fff;
    box-shadow: 0 6px 16px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.25);
  }

  /* Main panel stretches to fill remaining height */
  .panel{
    display:grid; grid-template-columns:1fr; min-height: 0; /* allow child to stretch */
  }
  .convo-card{
    display:grid;
    grid-template-rows: auto minmax(0,1fr) auto; /* header + scroll area + controls */
    background:var(--surface); border:1px solid rgba(255,255,255,.1);
    border-radius: var(--radius); box-shadow: var(--shadow-lg);
    min-height: 0; height: 100%;
  }
  .chat-head {
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 14px; border-bottom:1px solid rgba(255,255,255,.1);
    background:var(--surface); border-radius: var(--radius) var(--radius) 0 0;
  }
  .chat-head .title { font-weight:600; font-size:1rem; }

  /* These are the scrollable middles that grow to the bottom */
  #conversation, #readerView{
    padding:16px; background:transparent;
    overflow: auto; /* scroll inside, not the whole page */
    min-height: 0;
  }

  /* Bubbles */
  .message{
    display:flex; align-items:flex-start; gap:12px; margin:14px 0;
    opacity:0; transform:translateY(10px); animation:fadeIn .25s ease forwards;
  }
  @keyframes fadeIn{ to{ opacity:1; transform:translateY(0) } }
  .message.user{ flex-direction: row-reverse }
  .avatar{
    width:var(--avatar); height:var(--avatar); border-radius:50%;
    display:grid; place-items:center; background:var(--surface);
    box-shadow:var(--shadow-md); border:1px solid rgba(255,255,255,.1);
    flex: 0 0 var(--avatar); min-width:var(--avatar); min-height:var(--avatar);
  }
  .avatar svg{ width:calc(var(--avatar)*.55); height:calc(var(--avatar)*.55); fill:var(--ink) }
  @media (max-width: 600px){
    .avatar{ width:var(--avatar-sm); height:var(--avatar-sm); flex-basis:var(--avatar-sm);
      min-width:var(--avatar-sm); min-height:var(--avatar-sm); }
    .avatar svg{ width:calc(var(--avatar-sm)*.55); height:calc(var(--avatar-sm)*.55); }
  }

  .bubble{
    position:relative; max-width:75ch; padding:12px 16px; border-radius:14px; line-height:1.5;
    font-size:1rem; border:1px solid rgba(255,255,255,.08); box-shadow:var(--shadow-md);
  }
  .bubble.bot{ background:var(--bot); border-top-left-radius:4px }
  .bubble.user{ background:var(--user); border-top-right-radius:4px }
  .footer{ font-size: small; }
  .divider{ height:8px; opacity:.15; }

  /* Reader mode */
  .reader-tools{ display:flex; align-items:center; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
  .reader-text{
    display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end;
    background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.1);
    padding:14px; border-radius:12px;
  }
  .wtoken{
    display:flex; flex-direction:column; align-items:center; gap:2px;
    padding:6px 8px; border-radius:10px;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1);
  }
  .wtoken .w{ font-weight:700 }
  .wtoken .p{ font-size:.8rem; color:var(--ink-muted) }

  /* Centered unified record button */
  .controls {
    display:flex; align-items:center; justify-content:center;
    gap:10px; padding:16px 12px;
    border-top:1px solid rgba(255,255,255,.1); background:var(--surface);
    border-radius: 0 0 var(--radius) var(--radius);
  }
  .record-btn {
    width:64px; height:64px; border-radius:50%; border:none; cursor:pointer;
    background: radial-gradient(65% 65% at 50% 40%, var(--accent-2), var(--accent));
    color:#fff; display:grid; place-items:center;
    box-shadow:0 4px 12px rgba(0,0,0,.45);
    transition: transform .18s ease, filter .18s ease; outline:none;
  }
  .record-btn:hover{ transform: scale(1.06); filter: brightness(1.08) }
  .record-btn:active{ transform: scale(.94) }
  .record-btn svg{ width:28px; height:28px; filter: drop-shadow(0 2px 2px rgba(0,0,0,.35)) }